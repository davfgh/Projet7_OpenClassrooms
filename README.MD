# Documentation de l'API et de l'Interface Streamlit pour le Scoring Client

## 1ï¸. Introduction

Cette web application permet d'effectuer des **prÃ©dictions sur la fiabilitÃ© d'un client** en fonction de ses caractÃ©ristiques financiÃ¨res.

Elle repose sur **deux composants principaux** :
- **Une API Flask**, exposant un modÃ¨le de machine learning, permettant d'obtenir un score de risque et des valeurs explicatives via SHAP.
- **Une interface utilisateur Streamlit**, permettant dâ€™explorer les prÃ©dictions et dâ€™interagir avec le modÃ¨le de maniÃ¨re intuitive.

L'API peut Ãªtre utilisÃ©e **en local** ou **via le dÃ©ploiement sur le cloud**.

---

## 2ï¸. **Architecture**

### API Flask
- Chargement du modÃ¨le stockÃ© dans un fichier pickle.
- VÃ©rification des donnÃ©es d'entrÃ©e.
- PrÃ©diction du risque client via le modÃ¨le.
- Retour des rÃ©sultats sous forme de rÃ©ponse JSON.

### Interface Streamlit
- Affichage des **informations client**.
- Comparaison des caractÃ©ristiques avec des moyennes globales.
- GÃ©nÃ©ration dâ€™une **prÃ©diction et ajustement dâ€™un seuil dynamique**.
- Visualisation des **valeurs SHAP locales** pour comprendre l'impact des variables sur la dÃ©cision.

---

## 3ï¸. **ModÃ©lisation**

### **Notebook de ModÃ©lisation**
Un notebook dÃ©diÃ© Ã  la modÃ©lisation est disponible Ã  la racine du projet :
`Farizon_David_notebook_modelisation_012025.ipynb`

Ce notebook comprend les Ã©tapes suivantes :
- **Feature extraction** Ã  partir d'un notebook issu de la compÃ©tition Kaggle **Home Credit Default Risk**.
- **Analyse exploratoire rapide** des features extraites.
- **ModÃ©lisation avec 3 modÃ¨les** :
  - Dummy Classifier
  - RÃ©gression Logistique
  - LightGBM
- **Optimisation du seuil de probabilitÃ©s** sur le meilleur modÃ¨le sÃ©lectionnÃ©.
- **Dernier entraÃ®nement du modÃ¨le sÃ©lectionnÃ©** sur le jeu d'entraÃ®nement.
- **Export du modÃ¨le final** au format **pickle**.

### **Suivi des ExpÃ©riences avec MLFlow**
Le projet intÃ¨gre **MLFlow** pour suivre et enregistrer les expÃ©riences de modÃ©lisation :
- Stockage des modÃ¨les et des hyperparamÃ¨tres.
- Enregistrement automatique des mÃ©triques de performance.
- Visualisation des runs d'entraÃ®nement.

Les expÃ©riences sont stockÃ©es dans :
`models/` *(Dossier MLFlow)*
`mlruns.db` *(Base de donnÃ©es MLFlow)*

Pour visualiser les expÃ©riences MLFlow, lancez la commande suivante :
```bash
mlflow ui --backend-store-uri mlruns/
```

Puis, ouvrez le navigateur Ã  l'adresse :
**http://127.0.0.1:5000**

### ğŸ”¹ **Rapport Evidently sur le Data Drift**
Un rapport Evidently est gÃ©nÃ©rÃ© pour analyser le **data drift**, disponible Ã  l'emplacement suivant :
`evidently/report/`
`Farizon_David_4_Tableau_HTML_data_drift_evidently_012025.html`

Ce rapport permet de surveiller et d'Ã©valuer les variations des distributions de donnÃ©es entre les diffÃ©rentes pÃ©riodes d'entraÃ®nement et de prÃ©diction.

---

## 4. **Installation et ExÃ©cution**

### **4.1 PrÃ©requis**
Avant de dÃ©marrer lâ€™API et Streamlit en local, assurez-vous dâ€™avoir installÃ© les dÃ©pendances nÃ©cessaires :
```bash
pip install -r requirements.txt
```

### **4.2 Lancement de lâ€™API en local**
Si lâ€™API est dÃ©jÃ  en cours dâ€™exÃ©cution, il faut dâ€™abord la stopper avant de la relancer :
```bash
taskkill /F /IM python.exe
```

Ensuite, exÃ©cutez les commandes suivantes pour dÃ©marrer l'API :
```bash
cd api
python app.py
```

Elle sâ€™exÃ©cutera sur `http://127.0.0.1:5000/`.

**Note** : Cette Ã©tape n'est pas nÃ©cessaire pour la version dÃ©ployÃ©e sur le web.

### **4.3 Lancement de l'Interface Streamlit en local**
AprÃ¨s avoir dÃ©marrÃ© lâ€™API, lancez Streamlit avec la commande suivante :
```bash
cd streamlit_app
streamlit run streamlit_app.py
```

Par dÃ©faut, Streamlit sera accessible Ã  l'adresse suivante :
- **Sur la machine locale** : `http://localhost:8501`
- **Sur le rÃ©seau local (si configurÃ©)** : `http://<IP_LOCAL>:8501`

---

## 5. **DÃ©ploiement Automatique sur le Cloud**
Lâ€™API est dÃ©ployÃ©e sur **Azure** et accessible Ã  l'adresse suivante :
**https://prediction-api.azurewebsites.net**

**DÃ©ploiement automatique**
Ce projet utilise le centre de dÃ©ploiement Azure, assurant un **dÃ©ploiement continu**.
Le fichier `.github/workflows/api-deployment_prediction.yml` est issu du dÃ©ploiement automatique gÃ©nÃ©rÃ© par Azure.
Une Ã©tape supplÃ©mentaire a Ã©tÃ© ajoutÃ©e dans la section `build` pour exÃ©cuter les **tests unitaires** avant le dÃ©ploiement.

**DurÃ©e du processus** : Le dÃ©ploiement peut prendre jusqu'Ã  **30 minutes**.

---

## 6. **Endpoints de lâ€™API**

### **6.1 Endpoint de prÃ©diction (`/predict`)**
- **URL en local** : `http://127.0.0.1:5000/predict`
- **URL aprÃ¨s dÃ©ploiement** : `https://prediction-api.azurewebsites.net/predict`
- **MÃ©thode** : `POST`
- **Description** : Prend en entrÃ©e un dictionnaire JSON contenant les caractÃ©ristiques d'un client et retourne la prÃ©diction du modÃ¨le.

#### **Exemple de requÃªte**
```json
{
  "AMT_ANNUITY": 15000,
  "AMT_CREDIT": 200000,
  "AMT_GOODS_PRICE": 180000,
  "CREDIT_TERM": 60,
  "DAYS_BIRTH": -12000,
  "DAYS_ID_PUBLISH": -3000,
  "DAYS_REGISTRATION": -4000,
  "EXT_SOURCE_1": 0.5,
  "EXT_SOURCE_2": 0.7,
  "EXT_SOURCE_3": 0.6,
  "DEBT_CREDIT_RATIO": 0.3,
  "ANNUITY_BIRTH_RATIO": 0.02,
  "ANNUITY_INCOME_PERCENT": 0.1,
  "CREDIT_GOODS_RATIO": 1.1,
  "INSTA_AMT_PAYMENT": 10000,
  "INSTA_NUM_INSTALMENT_VERSION": 3,
  "POS_CNT_INSTALMENT_FUTURE": 2,
  "PREV_CNT_PAYMENT": 12
}
```

#### **Exemple de rÃ©ponse**
```json
{
    "lower_bound": 0.47000000000000003,
    "margin": 0,
    "optimal_threshold": 0.47000000000000003,
    "prediction": "Classe_0 (fiable)",
    "probability_class_0": 0.7965365906433127,
    "probability_class_1": 0.20346340935668727,
    "upper_bound": 0.47000000000000003
}
```

### **6.2 Endpoint des valeurs SHAP (`/shap_values`)**
- **URL en local** : `http://127.0.0.1:5000/shap_values`
- **URL aprÃ¨s dÃ©ploiement** : `https://prediction-api.azurewebsites.net/shap_values`
- **MÃ©thode** : `GET`
- **Description** : Retourne les valeurs SHAP pour expliquer la dÃ©cision du modÃ¨le sur un client donnÃ©.

#### **Exemple de rÃ©ponse**
```json
{
    "base_values": -0.7438573109528505,
    "features_names": [
        "AMT_ANNUITY",
        "AMT_CREDIT",
        "AMT_GOODS_PRICE",
        "ANNUITY_INCOME_PERCENT",
        "CREDIT_GOODS_RATIO",
        "CREDIT_TERM",
        "DAYS_BIRTH",
        "DAYS_ID_PUBLISH",
        "DAYS_REGISTRATION",
        "DEBT_CREDIT_RATIO",
        "EXT_SOURCE_1",
        "EXT_SOURCE_2",
        "EXT_SOURCE_3",
        "INSTA_AMT_PAYMENT",
        "INSTA_NUM_INSTALMENT_VERSION",
        "POS_CNT_INSTALMENT_FUTURE",
        "PREV_CNT_PAYMENT"
    ],
    "sample_values": [
        [
            0.8909397409758836,
            0.08973204731496785,
            0.32072747706903165,
            0.4984264892130457,
            -0.20075803566475942,
            1.070873783523731,
            0.9541051485718979,
            -0.8382782531774322,
            1.5035750809363868,
            1.187847533926258,
            -1.4975092984482719,
            1.3295106903291087,
            -1.3488443099480953,
            0.0521144846901881,
            -0.8374556177651016,
            0.08371349049402538,
            -1.2720999017458583
        ]
    ],
    "shap_values": [
        [
            -0.010641224200687333,
            -0.0008106912275832734,
            0.002393538705481381,
            0.004372882501110571,
            -0.04106824406961996,
            -0.008260239906941412,
            0.035637388022227594,
            0.001301685287086701,
            0.0002388982934175701,
            0.09724037024202416,
            0.19869268928905112,
            -0.32390777184358877,
            0.6972116554472935,
            0.01674885687250339,
            0.015972481375106144,
            -0.0035605964245221527,
            -0.004908864388482032
        ]
    ]
}
```

---

## 7. **Fichier OpenAPI pour tests sur Postman**
Le fichier `openapi.yml` situÃ© dans le dossier `api/` permet de tester facilement les endpoints via **Postman** ou **Swagger UI**.

---

## 8. **Tests de l'API**
Les **tests unitaires** sont exÃ©cutÃ©s automatiquement lors du **dÃ©ploiement sur Azure**.
Ils permettent de s'assurer que les endpoints `/predict` et `/shap_values` fonctionnent correctement.

Pour tester l'API Ã  la fois en local et aprÃ¨s dÃ©ploiement, vous pouvez utiliser le notebook :
ğŸ“‚ `api/Farizon_David_5_notebook_test_API_0125.ipynb`

---

## 9. **Structure des fichiers**
```bash
ğŸ“‚ projet-scoring-client
â”‚â”€â”€ ğŸ“‚ api
â”‚   â”‚â”€â”€ app.py                # Script principal de l'API Flask
â”‚   â”‚â”€â”€ Farizon_David_5_notebook_test_API_0125.ipynb  # Notebook pour tester l'API
â”‚   â”‚â”€â”€ openapi.yml            # SpÃ©cification OpenAPI pour tester l'API via Postman
â”‚â”€â”€ ğŸ“‚ models
â”‚   â”‚â”€â”€ lgbm_final_model.pkl  # ModÃ¨le final utilisÃ© par l'API
â”‚â”€â”€ ğŸ“‚ models                # Dossier MLFlow
â”‚â”€â”€ mlruns.db                # Base de donnÃ©es MLFlow
â”‚â”€â”€ ğŸ“‚ features
â”‚   â”‚â”€â”€ app_test_features.csv # DonnÃ©es de test (features)
â”‚â”€â”€ ğŸ“‚ streamlit
â”‚   â”‚â”€â”€ streamlit_app.py      # Interface utilisateur Streamlit
â”‚â”€â”€ ğŸ“‚ evidently
â”‚   â”‚â”€â”€ report
â”‚   â”‚   â”‚â”€â”€ Farizon_David _4_Tableau_HTML_data_drift_evidently_012025.html  # Rapport Data Drift Evidently
â”‚â”€â”€ .venv                     # Environement Python
â”‚â”€â”€ .gitignore
â”‚â”€â”€ requirements.txt          # DÃ©pendances utilisÃ©es dans le .venv
â”‚â”€â”€ requirements-prod.txt     # DÃ©pendances utilisÃ©es pour le dÃ©ploiement de l'API
â”‚â”€â”€ Farizon_David_2_notebook_modelisation_012025.ipynb  # Notebook de modÃ©lisation
â”‚â”€â”€ README.md
â”‚â”€â”€ ğŸ“‚ .github
â”‚   â”‚â”€â”€ workflows
â”‚   â”‚   â”‚â”€â”€ api-deployment_prediction.yml  # CI/CD utilisÃ© pour le dÃ©ploiement de l'API
```

**Bonne utilisation de lâ€™API et de lâ€™interface Streamlit !**
