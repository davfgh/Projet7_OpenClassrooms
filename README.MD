# Documentation de l'API et de l'Interface Streamlit pour le Scoring Client

## 1ï¸. Introduction

Cette web application permet d'effectuer des **prÃ©dictions sur la fiabilitÃ© d'un client** en fonction de ses caractÃ©ristiques financiÃ¨res.

Elle repose sur **deux composants principaux** :
- **Une API Flask**, exposant un modÃ¨le de machine learning, permettant d'obtenir un score de risque et des valeurs explicatives via SHAP.
- **Une interface utilisateur Streamlit**, permettant dâ€™explorer les prÃ©dictions et dâ€™interagir avec le modÃ¨le de maniÃ¨re intuitive.

L'API peut Ãªtre utilisÃ©e **en local** ou **via le dÃ©ploiement sur le cloud**.

---

## 2ï¸. **Architecture**

### API Flask
- Chargement du modÃ¨le stockÃ© dans un fichier pickle.
- VÃ©rification des donnÃ©es d'entrÃ©e.
- PrÃ©diction du risque client via le modÃ¨le.
- Retour des rÃ©sultats sous forme de rÃ©ponse JSON.

### Interface Streamlit
- Affichage des **informations client**.
- Comparaison des caractÃ©ristiques avec des moyennes globales.
- GÃ©nÃ©ration dâ€™une **prÃ©diction et ajustement dâ€™un seuil dynamique**.
- Visualisation des **valeurs SHAP locales** pour comprendre l'impact des variables sur la dÃ©cision.

---

## 3ï¸. **Installation et ExÃ©cution**

### **3.1 PrÃ©requis**
Avant de dÃ©marrer lâ€™API et Streamlit en local, assurez-vous dâ€™avoir installÃ© les dÃ©pendances nÃ©cessaires :
```bash
pip install -r requirements.txt
```

### **3.2 Lancement de lâ€™API en local**
Si lâ€™API est dÃ©jÃ  en cours dâ€™exÃ©cution, il faut dâ€™abord la stopper avant de la relancer :
```bash
taskkill /F /IM python.exe
```

Ensuite, exÃ©cutez les commandes suivantes pour dÃ©marrer l'API :
```bash
cd api
python app.py
```

Elle sâ€™exÃ©cutera sur `http://127.0.0.1:5000/`.

**Note** : Cette Ã©tape n'est pas nÃ©cessaire pour la version dÃ©ployÃ©e sur le web.

### **3.3 Lancement de l'Interface Streamlit en local**
AprÃ¨s avoir dÃ©marrÃ© lâ€™API, lancez Streamlit avec la commande suivante :
```bash
cd streamlit_app
streamlit run streamlit_app.py
```

Par dÃ©faut, Streamlit sera accessible Ã  l'adresse suivante :
- **Sur la machine locale** : `http://localhost:8501`
- **Sur le rÃ©seau local (si configurÃ©)** : `http://<IP_LOCAL>:8501`

---

## 4ï¸. **DÃ©ploiement Automatique sur le Cloud**
Lâ€™API est dÃ©ployÃ©e sur **Azure** et accessible Ã  l'adresse suivante :
**https://prediction-api.azurewebsites.net**

**DÃ©ploiement automatique**
Ce projet utilise le centre de dÃ©ploiement Azure, assurant un **dÃ©ploiement continu**.
Le fichier `.github/workflows/api-deployment_prediction.yml` est issu du dÃ©ploiement automatique gÃ©nÃ©rÃ© par Azure.
Une Ã©tape supplÃ©mentaire a Ã©tÃ© ajoutÃ©e dans la section `build` pour exÃ©cuter les **tests unitaires** avant le dÃ©ploiement.

**DurÃ©e du processus** : Le dÃ©ploiement peut prendre jusqu'Ã  **30 minutes**.

---

## 5ï¸. **Endpoints de lâ€™API**

### **5.1 Endpoint de prÃ©diction (`/predict`)**
- **URL en local** : `http://127.0.0.1:5000/predict`
- **URL aprÃ¨s dÃ©ploiement** : `https://prediction-api.azurewebsites.net/predict`
- **MÃ©thode** : `POST`
- **Description** : Prend en entrÃ©e un dictionnaire JSON contenant les caractÃ©ristiques d'un client et retourne la prÃ©diction du modÃ¨le.

#### **Exemple de requÃªte**
```json
{
    "AMT_ANNUITY": 15000,
    "AMT_CREDIT": 200000,
    "AMT_GOODS_PRICE": 180000,
    "CREDIT_TERM": 60,
    "DAYS_BIRTH": -12000,
    "DAYS_ID_PUBLISH": -3000,
    "DAYS_REGISTRATION": -4000,
    "EXT_SOURCE_1": 0.5,
    "EXT_SOURCE_2": 0.7,
    "EXT_SOURCE_3": 0.6,
    "DEBT_CREDIT_RATIO": 0.3
}
```

#### **Exemple de rÃ©ponse**
```json
{
    "prediction": "Classe_0 (fiable)",
    "probability_class_1": 0.120,
    "probability_class_0": 0.880,
    "optimal_threshold": 0.150,
    "margin": 0.000,
    "lower_bound": 0.150,
    "upper_bound": 0.150
}
```

### **5.2 Endpoint des valeurs SHAP (`/shap_values`)**
- **URL en local** : `http://127.0.0.1:5000/shap_values`
- **URL aprÃ¨s dÃ©ploiement** : `https://prediction-api.azurewebsites.net/shap_values`
- **MÃ©thode** : `GET`
- **Description** : Retourne les valeurs SHAP pour expliquer la dÃ©cision du modÃ¨le sur un client donnÃ©.

#### **Exemple de rÃ©ponse**
```json
{
    "shap_values": [-0.05, 0.02, -0.01, 0.08],
    "features_names": ["AMT_ANNUITY", "AMT_CREDIT", "AMT_GOODS_PRICE", "DAYS_BIRTH"],
    "sample_values": [15000, 200000, 180000, -12000],
    "base_values": 0.6
}
```

---

## 6ï¸. **Fichier OpenAPI pour tests sur Postman**
Le fichier `openapi.yml` situÃ© dans le dossier `api/` permet de tester facilement les endpoints via **Postman** ou **Swagger UI**.

---

## 7ï¸. **Tests de l'API**
Les **tests unitaires** sont exÃ©cutÃ©s automatiquement lors du **dÃ©ploiement sur Azure**.
Ils permettent de s'assurer que les endpoints `/predict` et `/shap_values` fonctionnent correctement.

Pour tester l'API Ã  la fois en local et aprÃ¨s dÃ©ploiement, vous pouvez utiliser le notebook :
ğŸ“‚ `api/Farizon_David_5_notebook_test_API_0125.ipynb`

---

## 8ï¸. **Structure des fichiers**
```bash
ğŸ“‚ projet-scoring-client
â”‚â”€â”€ ğŸ“‚ api
â”‚   â”‚â”€â”€ app.py                # Script principal de l'API Flask
â”‚   â”‚â”€â”€ Farizon_David_5_notebook_test_API_0125.ipynb  # Notebook pour tester l'API
â”‚   â”‚â”€â”€ openapi.yml            # SpÃ©cification OpenAPI pour Postman
â”‚â”€â”€ ğŸ“‚ models
â”‚   â”‚â”€â”€ lgbm_final_model.pkl  # ModÃ¨le ML
â”‚â”€â”€ ğŸ“‚ features
â”‚   â”‚â”€â”€ app_test_features.csv # DonnÃ©es de test
â”‚â”€â”€ ğŸ“‚ streamlit
â”‚   â”‚â”€â”€ streamlit_app.py      # Interface utilisateur
â”‚â”€â”€ requirements.txt          # DÃ©pendances
â”‚â”€â”€ README.md                 # Documentation
â”‚â”€â”€ .github/workflows/api-deployment_prediction.yml  # CI/CD
```

**Bonne utilisation de lâ€™API et de lâ€™interface Streamlit !**
