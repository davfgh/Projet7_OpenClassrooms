# Documentation de l'API et de l'Interface Streamlit pour le Scoring Client

## 1Ô∏è. Introduction

Cette web application permet d'effectuer des **pr√©dictions sur la fiabilit√© d'un client** en fonction de ses caract√©ristiques financi√®res.

Elle repose sur **deux composants principaux** :
- **Une API Flask**, exposant un mod√®le de machine learning, permettant d'obtenir un score de risque et des valeurs explicatives via SHAP.
- **Une interface utilisateur Streamlit**, permettant d‚Äôexplorer les pr√©dictions et d‚Äôinteragir avec le mod√®le de mani√®re intuitive.

L'API peut √™tre utilis√©e **en local** ou **via le d√©ploiement sur le cloud**.

---

## 2Ô∏è. **Architecture**

### API Flask
- Chargement du mod√®le stock√© dans un fichier pickle.
- V√©rification des donn√©es d'entr√©e.
- Pr√©diction du risque client via le mod√®le.
- Retour des r√©sultats sous forme de r√©ponse JSON.

### Interface Streamlit
- Affichage des **informations client**.
- Comparaison des caract√©ristiques avec des moyennes globales.
- G√©n√©ration d‚Äôune **pr√©diction et ajustement d‚Äôun seuil dynamique**.
- Visualisation des **valeurs SHAP locales** pour comprendre l'impact des variables sur la d√©cision.

---

## 3Ô∏è. **Mod√©lisation**

### **Notebook de Mod√©lisation**
Un notebook d√©di√© √† la mod√©lisation est disponible √† la racine du projet :
`Farizon_David_notebook_modelisation_012025.ipynb`

Ce notebook comprend les √©tapes suivantes :
- **Feature extraction** √† partir d'un notebook issu de la comp√©tition Kaggle **Home Credit Default Risk**.
- **Analyse exploratoire rapide** des features extraites.
- **Mod√©lisation avec 3 mod√®les** :
  - Dummy Classifier
  - R√©gression Logistique
  - LightGBM
- **Optimisation du seuil de probabilit√©s** sur le meilleur mod√®le s√©lectionn√©.
- **Dernier entra√Ænement du mod√®le s√©lectionn√©** sur le jeu d'entra√Ænement.
- **Export du mod√®le final** au format **pickle**.

### **Suivi des Exp√©riences avec MLFlow**
Le projet int√®gre **MLFlow** pour suivre et enregistrer les exp√©riences de mod√©lisation :
- Stockage des mod√®les et des hyperparam√®tres.
- Enregistrement automatique des m√©triques de performance.
- Visualisation des runs d'entra√Ænement.

Les exp√©riences sont stock√©es dans :
`models/` *(Dossier MLFlow)*
`mlruns.db` *(Base de donn√©es MLFlow)*

Pour visualiser les exp√©riences MLFlow, lancez la commande suivante :
```bash
mlflow ui --backend-store-uri mlruns/
```

Puis, ouvrez le navigateur √† l'adresse :
**http://127.0.0.1:5000**

### **Rapport Evidently sur le Data Drift**
Un rapport Evidently est g√©n√©r√© pour analyser le **data drift**, disponible √† l'emplacement suivant :
`evidently/report/`
`Farizon_David_4_Tableau_HTML_data_drift_evidently_012025.html`

Ce rapport permet de surveiller et d'√©valuer les variations des distributions de donn√©es entre les diff√©rentes p√©riodes d'entra√Ænement et de pr√©diction.

---

## 4. **Installation et Ex√©cution**

### **4.1 Pr√©requis**
Avant de d√©marrer l‚ÄôAPI et Streamlit en local, assurez-vous d‚Äôavoir install√© les d√©pendances n√©cessaires :
```bash
pip install -r requirements.txt
```

### **4.2 Lancement de l‚ÄôAPI en local**
Si l‚ÄôAPI est d√©j√† en cours d‚Äôex√©cution, il faut d‚Äôabord la stopper avant de la relancer :
```bash
taskkill /F /IM python.exe
```

Ensuite, ex√©cutez les commandes suivantes pour d√©marrer l'API :
```bash
cd api
python app.py
```

Elle s‚Äôex√©cutera sur `http://127.0.0.1:5000/`.

**Note** : Cette √©tape n'est pas n√©cessaire pour la version d√©ploy√©e sur le web.

### **4.3 Lancement de l'Interface Streamlit en local**
Apr√®s avoir d√©marr√© l‚ÄôAPI, lancez Streamlit avec la commande suivante :
```bash
cd streamlit_app
streamlit run streamlit_app.py
```

Par d√©faut, Streamlit sera accessible √† l'adresse suivante :
- **Sur la machine locale** : `http://localhost:8501`
- **Sur le r√©seau local (si configur√©)** : `http://<IP_LOCAL>:8501`

---

## 5. **D√©ploiement Automatique sur le Cloud**
L‚ÄôAPI est d√©ploy√©e sur **Azure** et accessible √† l'adresse suivante :
**https://prediction-api.azurewebsites.net**

**D√©ploiement automatique**
Ce projet utilise le centre de d√©ploiement Azure, assurant un **d√©ploiement continu**.
Le fichier `.github/workflows/api-deployment_prediction.yml` est issu du d√©ploiement automatique g√©n√©r√© par Azure.
Une √©tape suppl√©mentaire a √©t√© ajout√©e dans la section `build` pour ex√©cuter les **tests unitaires** avant le d√©ploiement.

**Dur√©e du processus** : Le d√©ploiement peut prendre jusqu'√† **30 minutes**.

---

## 6. **Endpoints de l‚ÄôAPI**

### **6.1 Endpoint de pr√©diction (`/predict`)**
- **URL en local** : `http://127.0.0.1:5000/predict`
- **URL apr√®s d√©ploiement** : `https://prediction-api.azurewebsites.net/predict`
- **M√©thode** : `POST`
- **Description** : Prend en entr√©e un dictionnaire JSON contenant les caract√©ristiques d'un client et retourne la pr√©diction du mod√®le.

#### **Exemple de requ√™te**
```json
{
  "AMT_ANNUITY": 15000,
  "AMT_CREDIT": 200000,
  "AMT_GOODS_PRICE": 180000,
  "CREDIT_TERM": 60,
  "DAYS_BIRTH": -12000,
  "DAYS_ID_PUBLISH": -3000,
  "DAYS_REGISTRATION": -4000,
  "EXT_SOURCE_1": 0.5,
  "EXT_SOURCE_2": 0.7,
  "EXT_SOURCE_3": 0.6,
  "DEBT_CREDIT_RATIO": 0.3,
  "ANNUITY_BIRTH_RATIO": 0.02,
  "ANNUITY_INCOME_PERCENT": 0.1,
  "CREDIT_GOODS_RATIO": 1.1,
  "INSTA_AMT_PAYMENT": 10000,
  "INSTA_NUM_INSTALMENT_VERSION": 3,
  "POS_CNT_INSTALMENT_FUTURE": 2,
  "PREV_CNT_PAYMENT": 12
}
```

#### **Exemple de r√©ponse**
```json
{
    "lower_bound": 0.47000000000000003,
    "margin": 0,
    "optimal_threshold": 0.47000000000000003,
    "prediction": "Classe_0 (fiable)",
    "probability_class_0": 0.7965365906433127,
    "probability_class_1": 0.20346340935668727,
    "upper_bound": 0.47000000000000003
}
```

### **6.2 Endpoint des valeurs SHAP (`/shap_values`)**
- **URL en local** : `http://127.0.0.1:5000/shap_values`
- **URL apr√®s d√©ploiement** : `https://prediction-api.azurewebsites.net/shap_values`
- **M√©thode** : `GET`
- **Description** : Retourne les valeurs SHAP pour expliquer la d√©cision du mod√®le sur un client donn√©.

#### **Exemple de r√©ponse**
```json
{
    "base_values": -0.7438573109528505,
    "features_names": [
        "AMT_ANNUITY",
        "AMT_CREDIT",
        "AMT_GOODS_PRICE",
        "ANNUITY_INCOME_PERCENT",
        "CREDIT_GOODS_RATIO",
        "CREDIT_TERM",
        "DAYS_BIRTH",
        "DAYS_ID_PUBLISH",
        "DAYS_REGISTRATION",
        "DEBT_CREDIT_RATIO",
        "EXT_SOURCE_1",
        "EXT_SOURCE_2",
        "EXT_SOURCE_3",
        "INSTA_AMT_PAYMENT",
        "INSTA_NUM_INSTALMENT_VERSION",
        "POS_CNT_INSTALMENT_FUTURE",
        "PREV_CNT_PAYMENT"
    ],
    "sample_values": [
        [
            0.8909397409758836,
            0.08973204731496785,
            0.32072747706903165,
            0.4984264892130457,
            -0.20075803566475942,
            1.070873783523731,
            0.9541051485718979,
            -0.8382782531774322,
            1.5035750809363868,
            1.187847533926258,
            -1.4975092984482719,
            1.3295106903291087,
            -1.3488443099480953,
            0.0521144846901881,
            -0.8374556177651016,
            0.08371349049402538,
            -1.2720999017458583
        ]
    ],
    "shap_values": [
        [
            -0.010641224200687333,
            -0.0008106912275832734,
            0.002393538705481381,
            0.004372882501110571,
            -0.04106824406961996,
            -0.008260239906941412,
            0.035637388022227594,
            0.001301685287086701,
            0.0002388982934175701,
            0.09724037024202416,
            0.19869268928905112,
            -0.32390777184358877,
            0.6972116554472935,
            0.01674885687250339,
            0.015972481375106144,
            -0.0035605964245221527,
            -0.004908864388482032
        ]
    ]
}
```

---

## 7. **Fichier OpenAPI pour tests sur Postman**
Le fichier `openapi.yml` situ√© dans le dossier `api/` permet de tester facilement les endpoints via **Postman** ou **Swagger UI**.

---

## 8. **Tests de l'API**
Les **tests unitaires** sont ex√©cut√©s automatiquement lors du **d√©ploiement sur Azure**.
Ils permettent de s'assurer que les endpoints `/predict` et `/shap_values` fonctionnent correctement.

Pour tester l'API √† la fois en local et apr√®s d√©ploiement, vous pouvez utiliser le notebook :
üìÇ `api/Farizon_David_5_notebook_test_API_0125.ipynb`

---

## 9. **Structure des fichiers**
```bash
üìÇ projet-scoring-client
‚îÇ‚îÄ‚îÄ üìÇ api
‚îÇ   ‚îÇ‚îÄ‚îÄ app.py                # Script principal de l'API Flask
‚îÇ   ‚îÇ‚îÄ‚îÄ Farizon_David_5_notebook_test_API_0125.ipynb  # Notebook pour tester l'API
‚îÇ   ‚îÇ‚îÄ‚îÄ openapi.yml            # Sp√©cification OpenAPI pour tester l'API via Postman
‚îÇ‚îÄ‚îÄ üìÇ models
‚îÇ   ‚îÇ‚îÄ‚îÄ lgbm_final_model.pkl  # Mod√®le final utilis√© par l'API
‚îÇ‚îÄ‚îÄ üìÇ models                # Dossier MLFlow
‚îÇ‚îÄ‚îÄ mlruns.db                # Base de donn√©es MLFlow
‚îÇ‚îÄ‚îÄ üìÇ features
‚îÇ   ‚îÇ‚îÄ‚îÄ app_test_features.csv # Donn√©es de test (features)
‚îÇ‚îÄ‚îÄ üìÇ streamlit
‚îÇ   ‚îÇ‚îÄ‚îÄ streamlit_app.py      # Interface utilisateur Streamlit
‚îÇ‚îÄ‚îÄ üìÇ evidently
‚îÇ   ‚îÇ‚îÄ‚îÄ report
‚îÇ   ‚îÇ   ‚îÇ‚îÄ‚îÄ Farizon_David _4_Tableau_HTML_data_drift_evidently_012025.html  # Rapport Data Drift Evidently
‚îÇ‚îÄ‚îÄ .venv                     # Environement Python
‚îÇ‚îÄ‚îÄ .gitignore
‚îÇ‚îÄ‚îÄ requirements.txt          # D√©pendances utilis√©es dans le .venv
‚îÇ‚îÄ‚îÄ requirements-prod.txt     # D√©pendances utilis√©es pour le d√©ploiement de l'API
‚îÇ‚îÄ‚îÄ Farizon_David_2_notebook_modelisation_012025.ipynb  # Notebook de mod√©lisation
‚îÇ‚îÄ‚îÄ README.md
‚îÇ‚îÄ‚îÄ üìÇ .github
‚îÇ   ‚îÇ‚îÄ‚îÄ workflows
‚îÇ   ‚îÇ   ‚îÇ‚îÄ‚îÄ api-deployment_prediction.yml  # CI/CD utilis√© pour le d√©ploiement de l'API
```

**Bonne utilisation de l‚ÄôAPI et de l‚Äôinterface Streamlit !**
